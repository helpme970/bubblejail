#!/bin/bash

set -euo pipefail

# Exit if no argument is given
if [ $# -eq 0 ]; then
    echo "Bitte übergib den Programmnamen oder den Pfad zur Datei als Parameter"
    exit 1
fi

mkdir -p $HOME/.bubblejail/sandbox
mkdir -p $HOME/.bubblejail/profiles


if [[ ! -f $HOME/.bubblejail/tmp ]]; then
    echo "" > $HOME/.bubblejail/tmp
fi

cmd=" --unshare-net --unshare-ipc"
#user="user" # option to change username in sandbox, maybe in the futur
user="$USER"
debug=false
xsession=""
virt_home=""
tmp_home=""
box=""
userns=false
copy=""
dbus=""
chdir=""

for ((i=1 ; i<=$# ; i++ )); do
    arg=${!i}
    case "$arg" in
        -p|--programm) {
            cmd="$cmd --setenv USER $user"
            if [[ $user == "root" ]]; then
                new_home="/root"
                cmd="$cmd --setenv HOME /root"
            elif [[ $user == "nobody" || $user == "$USER" || $user == "user" ]]; then
                new_home="/home/$user"
                cmd="$cmd --setenv HOME /home/$user"
            fi

            cmd="$cmd --setenv XDG_CONFIG_HOME $new_home/.config"

            ((i++))
            program="${!i}"
            box2=""
            if [[ "$box" != "" && "$program" == *"/"* ]]; then
                box2="${box//--bind /}"
                box2="${box2// \//}"
            fi

            #if [[ "$program" == *"/"* ]]; then
            program2="${box2}${chdir}${program}"
            #fi

            if [[ "$program2" == *"/"* || "$program2" == *"."* ]]; then
                if [ -e "$(readlink -f "${program2}")" ]; then
                    program2="$(readlink -f "${program2}")"
                elif [ -e "$(readlink -f "${!i}")" ]; then
                    program2="${!i}"
                elif [ -e "$HOME/.bubblejail/sandbox/$program2" ]; then
                    program2="$HOME/.bubblejail/sandbox/$program2"
                else
                    echo "Program ${program2} does not exist"
                    exit 1
                fi
                if [ ! -x "$program2" ]; then
                    echo "$program2 is not executable. Change the permissions."
                    exit 1
                fi
                if [[ "${program:$((${#program}-1)):1}" == "/" ]]; then
                    program="${program[-1]}"
                fi
                if [[ "$program" == *"/"* ]]; then
                    IFS='/' read -r -a array <<< "$program"
                    programname=${array[-1]}
                    path="${program//$programname/}"
                else
                    programname="$program"
                    path="${PWD}"
                fi
                
                #if [[ "$program" == *"."* ]]; then
                #    IFS='.' read -r -a array <<< "${!i}"
                #    for ((i=0; i < ${#array}; i++)); do
                #        echo ${array[i]}
                #        programname="${programname}.${array[i]}"
                #    done
                #fi
            else
                programname="$program"
            fi

            if [ $userns = false ]; then
                cmd="$cmd --disable-userns --assert-userns-disabled"
            fi

            if [ "$virt_home" != "" ]; then
                mkdir -p $HOME/.bubblejail/sandbox/$programname$new_home
                cmd=" --bind ~/.bubblejail/sandbox/$programname /$cmd" #--bind ~/.bubblejail/sandbox/$programname$new_home $new_home$cmd"
            elif [ "$tmp_home" != "" ]; then
                cmd=" --tmpfs $new_home$cmd"
            elif [ "$box" != "" ]; then
                cmd=" ${box}${cmd}"
            else
                cmd=" --tmpfs $new_home$cmd"
            fi

            if [ ${#copy} -gt 0 ]; then
                IFS=';' read -ra copy <<< "$copy"
                for l in "${copy[@]}"; do
                    if [ -e "$HOME/.bubblejail/sandbox/$programname$l" ]; then
                        echo "$HOME/.bubblejail/sandbox/$programname$l already exists"
                        #exit
                    elif [ ! -e "$HOME/.bubblejail/sandbox/$programname$l" ]; then
                        echo "$HOME/.bubblejail/sandbox/$programname$l created"
                        if [ -d "$l" ]; then
                            if [ "${l:$((${#l}-1)):1}" == "/" ]; then
                                l=${l:$((${#l}-1))}
                            fi
                            IFS='/' read -r -a array <<< "$l"
                            array="${array[-1]}"
                            l2="${l//$array/ }"
                            mkdir -p $HOME/.bubblejail/sandbox/$programname$l2
                            #mkdir -p $HOME/.bubblejail/sandbox/$programname$l
                            cp -R "$l" "$HOME/.bubblejail/sandbox/$programname$l"
                            echo cp1
                        elif [ -f "$l" ]; then
                            IFS='/' read -r -a array <<< "$l"
                            array="${array[-1]}"
                            l2="${l//$array/ }"
                            mkdir -p $HOME/.bubblejail/sandbox/$programname$l2
                            cp "$l" "$HOME/.bubblejail/sandbox/$programname$l"
                            echo cp2
                        else
                            echo fehler
                            exit 1
                        fi
                    else
                        echo fehler
                        exit 1
                    fi
                    old="$l"
                    l="$HOME/.bubblejail/sandbox/$programname$l"
                    cmd="$cmd --bind \"$l\" \"$old\""
                done
            fi

            ########
            # DBus #
            ########
            if [[ "$dbus" != "" ]]; then
                mkdir -p $XDG_RUNTIME_DIR/xdg-dbus-proxy
                for l in {0..50}; do
                    if [ ! -e "$XDG_RUNTIME_DIR/xdg-dbus-proxy/$l.sock" ]; then
                        tmp="$l"
                        break
                    fi
                done
                xdg-dbus-proxy $DBUS_SESSION_BUS_ADDRESS $XDG_RUNTIME_DIR/xdg-dbus-proxy/$tmp.sock --filter $dbus & # --log
                cmd="$cmd --setenv DBUS_SESSION_BUS_ADDRESS unix:path="$XDG_RUNTIME_DIR"/bus --bind \"$XDG_RUNTIME_DIR/xdg-dbus-proxy/$tmp.sock\" \"$XDG_RUNTIME_DIR/bus\""
            fi
            
            ################
            # program name #
            ################
            if [[ $programname = *".appimage"* || $programname = *".Appimage"* || $programname = *".AppImage"* ]]; then
                if [ -e "$path/squashfs-root" ]; then
                    echo "$path/squashfs-root already exists, please remove it to continue"
                    exit 1
                fi
                if [ -d "$program.home" ]; then
                    cmd="$cmd --bind $program.home /home/$user"
                fi
                if [ -d "$program.config" ]; then
                    cmd="$cmd --bind $program.config /home/$user/.config"
                fi
                eval "$path$programname --appimage-extract" > /dev/null
                #mv "${path}squashfs-root" "$program-sandboxed"
                mv "${pwd}squashfs-root" "$program-sandboxed"
                debug=true
                cmd="$cmd --bind \"\${path//\$0/}\" \"\${path//\$0/}\" ./AppRun"
            else
                cmd="$cmd \"$program\""
            fi

            ((i++))
            
            for ((l=$i; l<=$#; l++)); do
                a="${!l}"
                #a="${a// /\\ }"
                #a="${a//(/\\(}"
                #a="${a//)/\\)}"
                #a="${a//\'/\\\'}"
                cmd="$cmd \"$a\""
            done
            #cmd="$cmd ${@:i}"

            # profiles
            if [ -e "$HOME/.bubblejail/profiles/$programname" ]; then
                cmd="bash \"$HOME/.bubblejail/profiles/$programname\""
            else
                # --as-pid-1
                # PID 1 is the init system, e.g. systemd
                cmd="bwrap --die-with-parent --unshare-user --unshare-cgroup --unshare-pid --unshare-uts --new-session --clearenv --hostname localhost --setenv XDG_RUNTIME_DIR $XDG_RUNTIME_DIR --setenv XDG_CACHE_HOME \"$new_home/.cache\"$cmd"
            fi

            break
            break
        };;
        -d|--debug) {
            debug=true
        };;
        -h|--help) {    
            echo "Usage: bubblejail.sh [OPTIONS] -p PROGRAM

-p, --program                       Followed by the program name or full path to execute.
-d, --debug                         Show all stdout/stderr output for troubleshooting.
-h, --help                          Display help information (still a work‑in‑progress).
-v, --version                       Print the versions of bubblejail and bubblewrap.
--video                             Auto‑detect and share the appropriate X11 or Wayland socket for GUI apps.
--wayland                           Explicitly share the Wayland socket.
--x11                               Share the default X11 socket.
--x11 :N                            Share the X11 socket of session N (e.g., :10).
--x11-sandbox                       Start a fresh X11 session with Xephyr and run the program inside it.
--audio                             Forward PulseAudio, PipeWire, ALSA, or OSS sockets for sound and mic access.
--gpu                               Enable hardware‑accelerated graphics inside the sandbox.
--cam, --webcam, --camera           Grant access to the webcam (requires v4l/v4l2).
--stdir                             Bind essential system directories needed by most programs.
--enable-userns, --share-userns     Allow additional user namespaces.
--share-ipc                         Permit inter‑process communication.
--net, --share-net, --network       Enable network connectivity.
--root                              Run the sandbox as UID 0.
--nobody                            Run as UID 65534 (the “nobody” user).
--current-user                      Use the invoking user’s UID (default).
--virt-home                         Use a persistent empty home directory.
--tmp-home                          Use a temporary home that is removed on exit.
--box <name>                        Create an isolated root for multiple programs under name.
--pass <SRC>                        Bind SRC to the same path inside the sandbox (read‑write).
--ro-pass <SRC>                     Same as --pass but read‑only.
--dev-pass <SRC>                    Bind with device permissions.
--pass-try <SRC>                    Like --pass but ignore missing paths.
--ro-pass-try <SRC>                 Read‑only version of --pass-try.
--dev-pass-try <SRC>                Device‑access version of --pass-try.
--bind <SRC> <DEST>                 Bind SRC to DEST inside the sandbox.
--ro-bind <SRC> <DEST>              Read‑only bind.
--dev-bind <SRC> <DEST>             Device‑access bind.
--bind-try <SRC> <DEST>             Bind without error on missing source.
--ro-bind-try <SRC> <DEST>          Read‑only version of --bind-try.
--dev-bind-try <SRC> <DEST>         Device‑access version of --bind-try.
--clone, --copy                     Copy a file or directory into the sandbox with write permissions.
--tmpfs, --tmp                      Create a temporary directory that disappears when the sandbox stops.
--pass-lang                         Propagate the host’s locale settings.
--usb                               Pass all USB drives with write access.
--ro-usb                            Same as --usb but read‑only.
--dbus <pattern>                    Grant the program ownership of matching D‑Bus names (e.g., org.example.portal.*).
--desktop-portal                    Allow secure access to external files, opening URLs, etc., via the desktop portal."
            exit
        };;
        -v|--version) {
            echo "bubblejail 1.0"
            bwrap --version
            echo "
Released under the GPL-3.0 license
bubblejail is created by helpme970"
            exit
        };;
        --video) {
            if [[ "$XDG_SESSION_TYPE" == "wayland" && "$WAYLAND_DISPLAY" != "" ]]; then
                cmd="$cmd --setenv WAYLAND_DISPLAY \"$WAYLAND_DISPLAY\" --ro-bind \"$XDG_RUNTIME_DIR/$WAYLAND_DISPLAY\" \"$XDG_RUNTIME_DIR/$WAYLAND_DISPLAY\""
            elif [[ "$XDG_SESSION_TYPE" == "x11" && "$DISPLAY" != "" ]]; then
                if [ "${!i+1}" == *":"* ]; then
                    ((i++))
                    cmd="$cmd --setenv DISPLAY \"${!i}\" --ro-bind /tmp/.X11-unix/X${!i} /tmp/.X11-unix/X${!i}"
                else
                    cmd="$cmd --setenv DISPLAY ":0" --ro-bind /tmp/.X11-unix/X0 /tmp/.X11-unix/X0"
                fi
            fi
        };;
        --wayland) {
            cmd="$cmd --setenv WAYLAND_DISPLAY \"$WAYLAND_DISPLAY\" --ro-bind \"$XDG_RUNTIME_DIR/$WAYLAND_DISPLAY\" \"$XDG_RUNTIME_DIR/$WAYLAND_DISPLAY\""
        };;
        --x11) {
            ((i++))
            if [[ "${!i}" == *":"* ]]; then
                cmd="$cmd --setenv DISPLAY \"${!i}\" --ro-bind /tmp/.X11-unix/X${!i:1} /tmp/.X11-unix/X${!i:1}"
            else
                i=$(($i-1))
                cmd="$cmd --setenv DISPLAY ":0" --ro-bind /tmp/.X11-unix/X0 /tmp/.X11-unix/X0"
            fi
        };;
        --x11-sandbox) {
            for l in {0..50}; do
                if [ ! -e "/tmp/.X11-unix/X$l" ]; then
                    xsession="$l"
                    break
                fi
            done
            #cmd="$cmd --setenv DISPLAY ":0" --ro-bind /tmp/.X11-unix/X$xsession /tmp/.X11-unix/X0"
            cmd="$cmd --setenv DISPLAY ":$xsession" --ro-bind /tmp/.X11-unix/X$xsession /tmp/.X11-unix/X$xsession"
        };;
        --audio) {
            # PulseAudio
            cmd="$cmd --ro-bind-try \"$XDG_RUNTIME_DIR/pulse/native\" \"$XDG_RUNTIME_DIR/pulse/native\""
            # --ro-bind-try ~/.config/pulse/cookie ~/.config/pulse/cookie
            # ^ only needed for audio over network

            # Pipewire
            #cmd="$cmd --ro-bind-try \"$XDG_RUNTIME_DIR/pipewire-0\" \"$XDG_RUNTIME_DIR/pipewire-0\""

            # ALSA
            cmd="$cmd --dev-bind-try /dev/snd /dev/snd"

            # OSS
            #cmd="$cmd --dev-bind-try /dev/dsp /dev/dsp"
        };;
        --gpu) {
            cmd="$cmd --dev-bind /dev/dri /dev/dri --ro-bind /sys/dev /sys/dev --ro-bind /sys/devices /sys/devices" # --ro-bind /sys /sys"
        };;
        --gpu) {
            cmd="$cmd --dev-bind /dev/kvm /dev/kvm" #/sys/devices/pci0000:00/ /sys/devices/pci0000:00/"
        };;
        --cam|--webcam|--camera) { # v4l
            cmd="$cmd --dev-bind /dev/v4l /dev/v4l --dev-bind /dev/video0 /dev/video0"
        };;
        --stdir) {
            cmd="$cmd --ro-bind /usr /usr --symlink /usr/bin /bin --symlink /usr/lib /lib --symlink /usr/lib64 /lib64 --symlink /usr/sbin /sbin --ro-bind /etc /etc --ro-bind-try /opt /opt --proc /proc --dev /dev --tmpfs /tmp --bind $HOME/.bubblejail/tmp /etc/hostname --chmod 000 /etc/hostname --bind $HOME/.bubblejail/tmp /etc/os-release --chmod 000 /etc/os-release --bind $HOME/.bubblejail/tmp /etc/shadow --chmod 000 /etc/shadow --bind $HOME/.bubblejail/tmp /etc/shadow- --chmod 000 /etc/shadow- --bind $HOME/.bubblejail/tmp /usr/lib/os-release --chmod 000 /usr/lib/os-release --bind $HOME/.bubblejail/tmp /var/lib/dbus/machine-id --chmod 000 /var/lib/dbus/machine-id --bind $HOME/.bubblejail/tmp /etc/machine-id --chmod 000 /etc/machine-id --tmpfs /usr/src --chmod 000 /usr/src --tmpfs /usr/lib/modules --chmod 000 /usr/lib/modules --tmpfs /usr/lib/gcc"
        };;
        --enable-userns|--share-userns) {
            userns=true           
        };;
        --net|--share-net|--network) {
            cmd="${cmd//--unshare-net/}"
            cmd="$cmd --share-net --ro-bind-try /run/systemd/resolve /run/systemd/resolve"
        };;
        --share-ipc) {
            cmd="${cmd//--unshare-ipc/}"
        };;
        --root) {
            cmd="$cmd --uid 0"
            user="root"
        };;
        --nobody) {
            cmd="$cmd --uid 65534"
            user="nobody"
        };;
        --current-user) {
            user="$USER"
        };;
        --virt-home) {
            virt_home=" "
        };;
        --tmp-home) {
            tmp_home=" "
        };;
        --box) {
            ((i++))
            if [ -e "$HOME/.bubblejail/sandbox/${!i}" ]; then
                tmp="${!i}"
            elif [ ! -e "$HOME/.bubblejail/sandbox/${!i}" ]; then
                mkdir -p "$HOME/.bubblejail/sandbox/${!i}"
                echo "Created new box ${!i}"
            fi
            box="--bind $HOME/.bubblejail/sandbox/${!i} /"
        };;
        --pass|--ro-pass|--dev-pass|--pass-try|--ro-pass-try|--dev-pass-try|--bind|--ro-bind|--dev-bind|--bind-try|--ro-bind-try|--dev-bind-try) {
            case $arg in
                --pass|--bind) {
                    cmd="$cmd --bind"
                };;
                --ro-pass|--ro-bind) {
                    cmd="$cmd --ro-bind"
                };;
                --dev-pass|--dev-bind) {
                    cmd="$cmd --dev-bind"
                };;
                --pass-try|--bind-try) {
                    cmd="$cmd --bind-try"
                };;
                --ro-pass-try|--ro-bind-try) {
                    cmd="$cmd --ro-bind-try"
                };;
                --dev-pass-try|--dev-bind-try) {
                    cmd="$cmd --dev-bind-try"
                };;
            esac
            ((i++))
            case "$arg" in
                --pass|--ro-pass|--dev-pass|--bind|--ro-bind|--dev-bind) {

                    tmp="$(readlink -f "${!i}")"
                    #tmp="${tmp// /\\ }"
                    #tmp="${tmp//(/\\(}"
                    #tmp="${tmp//)/\\)}"
                    if [ -e "$tmp" ]; then
                        :
                    elif [ ! -e "$(readlink -f ${!i})" ]; then
                        if [ -e "${!i}" ]; then
                            tmp="${!i}"
                        elif [ ! -e "${!i}" ]; then
                            echo "File ${!i} does not exist"
                            exit 1
                        fi
                    fi
                };;
                *) {
                    tmp="${!i}"
                };;
            esac
            case "$arg" in
                --pass|--ro-pass|--dev-pass|--pass-try|--ro-pass-try|--dev-pass-try) {            
                    cmd="$cmd \"${tmp}\" \"${tmp}\""
                };;
                --bind|--ro-bind|--dev-bind|--bind-try|--ro-bind-try|--dev-bind-try) {
                    cmd="$cmd \"${tmp}\""
                    ((i++))
                    cmd="$cmd \"${!i}\""
                };;
            esac
        };;
        --clone|--copy) {
            ((i++))
            if [ -e "$(readlink -f ${!i})" ]; then
                tmp="$(readlink -f ${!i})"
            elif [ ! -e "$(readlink -f ${!i})" ]; then
                if [ -e "${!i}" ]; then
                    tmp="${!i}"
                elif [ ! -e "${!i}" ]; then
                    echo "File ${!i} does not exist"
                    exit 1
                fi
            fi
            copy="$copy${tmp};"
        };;
        --tmpfs|--tmp) {
            cmd="$cmd --tmpfs"
            ((i++))
            cmd="$cmd ${!i}"
        };;
        --pass-lang) {
            cmd="$cmd --setenv LANGUAGE $LANGUAGE --setenv LANG $LANG"
        };;
        --usb) {
            cmd="$cmd --bind-try /media /media --bind-try /mnt /mnt --bind-try /run/media /run/media"
        };;
        --ro-usb) {
            cmd="$cmd --ro-bind-try /media /media --ro-bind-try /mnt /mnt --ro-bind-try /run/media /run/media"
        };;
        --dbus) {
            ((i++))
            dbus="$dbus --own=${!i}"
        };;
        --desktop-portal) {
            dbus="$dbus --talk=org.freedesktop.portal.*"
        };;

        ## bwrap parameter
        # do nothing
        --unshare-user|--unshare-user-try|--unshare-ipc|--unshare-pid|--unshare-net|--unshare-uts|--unshare-cgroup|--unshare-cgroup-try|--clearenv|--new-session|--die-with-parent|--disable-userns|--assert-userns-disabled) {
            echo "The parameter \"${!i}\" is already automaticaly used in bubblejail. You can remove it from your command because it does nothing."
        };;

        --unshare-all|--as-pid-1) {
            cmd="$cmd $arg"
        };;

        # one parameter
        --args|--argv0|--userns|--userns2|--pidns|--uid|--gid|--hostname|--unsetenv|--lock-file|--sync-fd|--remount-ro|--exec-label|--file-label|--proc|--dev|--tmpfs|--mqueue|--dir|--seccomp|--add-seccomp-fd|--block-fd|--userns-block-fd|--info-fd|--json-status-fd|--cap-add|--cap-drop|--perms|--size) {
            cmd="$cmd $arg"
            ((i++))
            cmd="$cmd ${!i}"
        };;
        --chdir) {
            ((i++))
            if [ -e "$(readlink -f ${!i})" ]; then
                tmp="$(readlink -f ${!i})"
            elif [ ! -e "$(readlink -f ${!i})" ]; then
                if [ -e "${!i}" ]; then
                    tmp="${!i}"
                elif [ ! -e "${!i}" ]; then
                    echo "File ${!i} does not exist"
                    exit 1
                fi
            fi
            chdir="$tmp"
            cmd="$cmd --chdir \"$tmp\""
        };;

        # two parameter
        --setenv|--bind-fd|--ro-bind-fd|--file|--bind-data|--ro-bind-data|--symlink|--chmod) {
            cmd="$cmd $arg"
            ((i++))
            cmd="$cmd '${!i}'"
            ((i++))
            cmd="$cmd '${!i}'"
        };;

        *) {
            echo "Falsches Argument $arg"
            exit 1
        };;
    esac
done

#if [[ $debug == false ]]; then
#    cmd="$cmd &> /dev/null"
#fi

if [[ $debug == true ]]; then
    echo "$cmd"
fi


{ # try
    if [ "$xsession" != "" ]; then
        final_cmd="
if command -v Xephyr &> /dev/null; then
    bash $0 --stdir --video --gpu --pass /tmp/.X11-unix/ --debug --audio -p Xephyr :$xsession -br +bs -c -fakescreenfps 1 -r -reset -xinerama -terminate -once +extension XFIXES +extension RENDER +extension SECURITY +extension GLX +extension XVideo +extension XVideo-MotionCompensation -resizeable -title \"$programname\" -no-host-grab -screen 1920x1080 & # -2button -softCursor
elif command -v xpra &> /dev/null; then
    bash $0 --stdir --video --pass /tmp/.X11-unix/ --debug --audio -p Xpra &
elif command -v Xnest &> /dev/null; then
    bash $0 --stdir --video --pass /tmp/.X11-unix/ --debug --audio -p Xnest -geometry 1900x1000 -name "$programname" :\$xsession &
else
    echo \"No X11 Host found\"
    exit 1
fi

sleep 0.2

if command -v bspwm &> /dev/null; then
    bash $0 --stdir --x11 :$xsession --gpu --debug -p vglrun bspwm &
elif command -v openbox &> /dev/null; then
    bash $0 --stdir --x11 :$xsession --gpu --debug -p vglrun openbox &
else
    echo \"No Desktop found\"
    exit 1
fi

#bash $0 --stdir --setenv DISPLAY ":0" --ro-bind /tmp/.X11-unix/X$xsession /tmp/.X11-unix/X0 --gpu --debug -p bspwm &

sleep 0.2"
    fi

    if [[ "$programname" == *".appimage"* || "$programname" == *".Appimage"* || "$programname" == *".AppImage"* ]]; then
        if [ "$xsession" != "" ]; then
            echo "#!/bin/bash
    path=\"\$(readlink -f \$0)\"
    eval $final_cmd" > $program-sandboxed/run-sandboxed.bash
        else
            echo "#!/bin/bash
    path=\"\$(readlink -f \$0)\"
    eval '$cmd'" > $program-sandboxed/run-sandboxed.bash
        fi
    else
        if [ "$xsession" != "" ]; then
            eval "$final_cmd"
            eval "$cmd"
        else
            eval "$cmd"
        fi
    fi
} || { # catch
    :
}

if [ "$xsession" != "" ]; then
    rm -f /tmp/.X11-unix/X$xsession
fi

pkill -P $$
